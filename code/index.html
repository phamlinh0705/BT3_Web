<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Thương Mại Điện Tử</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Montserrat', Arial, sans-serif;
            color: #333;
            background: linear-gradient(to bottom, #e0f7fa, #ffffff);
            min-height: 100vh;
        }
        main { max-width: 1200px; margin: 1.5rem auto; padding: 1rem; }
        nav {
            background-color: #1d3557; color: white; padding: 1.2rem;
            display: flex; justify-content: center; gap: 2.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        nav a {
            color: white; text-decoration: none; font-size: 1.1rem;
            font-weight: 600; cursor: pointer; transition: transform 0.2s ease;
        }
        nav a:hover { text-decoration: none; transform: translateY(-2px); }
        .page { display: none; }
        .page.active { display: block; }
        h2 { font-weight: 700; color: #1d3557; margin-bottom: 1.5rem; }
        h3 { font-weight: 600; color: #333; margin-bottom: 1rem; margin-top: 2rem; }
        
        /* CSS Sản phẩm */
        #product-list {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem;
        }
        .product-item {
            background-color: white; border: 1px solid #eee; border-radius: 8px;
            padding: 1rem; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .product-item:hover { transform: translateY(-5px); box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
        .product-item img { max-width: 100%; height: 170px; object-fit: cover; border-radius: 5px; }
        .product-item h3 {
            font-size: 1.1rem; margin: 0.75rem 0; font-weight: 600;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .product-item p { color: #e63946; font-weight: 700; font-size: 1.25rem; margin-bottom: 1rem; }
        
        /* CSS Nút bấm */
        button {
            border: none; padding: 0.6rem 1.2rem; border-radius: 5px;
            cursor: pointer; font-weight: 600; font-family: 'Montserrat', sans-serif;
            transition: background-color 0.2s ease;
        }
        .product-item button {
            background-color: #457b9d; color: white; width: 100%;
        }
        .product-item button:hover { background-color: #1d3557; }
        
        /* CSS Login */
        #login-form {
            max-width: 400px; margin: 3rem auto; padding: 2.5rem; background: white;
            border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }
        #login-form h2 { text-align: center; margin-bottom: 1.5rem; color: #1d3557; }
        #login-form div { margin-bottom: 1.2rem; }
        #login-form label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        #login-form input { width: 100%; padding: 0.7rem; border: 1px solid #ccc; border-radius: 5px; }
        #login-form button {
            width: 100%; padding: 0.8rem; background-color: #e63946;
            color: white; font-size: 1.1rem;
        }
        #login-form button:hover { background-color: #d62828; }
        #login-message { text-align: center; color: red; margin-top: 1rem; }
        
        /* --- (MỚI) CSS CHO GIỎ HÀNG & ĐẶT HÀNG --- */
        #cart-table {
            width: 100%; border-collapse: collapse; margin-top: 1rem;
            background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        #cart-table th, 
        #cart-table td {
            border: 1px solid #ddd; padding: 0.75rem; text-align: left; vertical-align: middle;
        }
        #cart-table th { background-color: #f4f7f6; }
        #cart-table img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; }
        #cart-table input[type="number"] { width: 60px; padding: 0.5rem; text-align: center; }
        #cart-table .remove-btn { background-color: #e63946; color: white; }
        
        .cart-summary {
            margin-top: 1.5rem; text-align: right; font-size: 1.5rem; font-weight: 700; color: #1d3557;
        }
        
        #checkout-form {
            max-width: 600px; margin: 2rem auto; padding: 2rem; background: white;
            border-radius: 8px; box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }
        #checkout-form div { margin-bottom: 1rem; }
        #checkout-form label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        #checkout-form input[type="text"],
        #checkout-form input[type="tel"],
        #checkout-form textarea {
            width: 100%; padding: 0.7rem; border: 1px solid #ccc; border-radius: 5px;
        }
        #checkout-form button {
            width: 100%; padding: 0.8rem; background-color: #2a9d8f;
            color: white; font-size: 1.1rem;
        }

        /* --- CSS CHO TRANG ADMIN --- */
        .grafana-container {
            border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; padding: 1rem;
        }
        #admin-order-table {
            width: 100%; border-collapse: collapse; margin-top: 1rem;
            background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        #admin-order-table th, #admin-order-table td {
            border: 1px solid #ddd; padding: 0.75rem; text-align: left; vertical-align: middle;
        }
        #admin-order-table th { background-color: #f4f7f6; font-size: 0.9rem; }
        #admin-order-table td input, #admin-order-table td select {
            width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;
        }
        #admin-order-table td button { background-color: #007bff; color: white; padding: 0.5rem 0.75rem; }
        #admin-order-table td button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <nav>
        <a id="nav-products">Sản Phẩm</a>
        <a id="nav-cart">Giỏ Hàng (<span id="cart-count">0</span>)</a>
        <a id="nav-login">Đăng Nhập</a>
        <a id="nav-admin" style="display:none;">Admin</a>
    </nav>

    <main>
        <div id="page-products" class="page active">
            <h2>Danh Sách Sản Phẩm</h2>
            <div id="product-list"><p>Đang tải sản phẩm...</p></div>
        </div>

        <div id="page-cart" class="page">
            </div>

        <div id="page-login" class="page">
            <form id="login-form">
                <h2>Đăng Nhập</h2>
                <div><label for="username">Tên đăng nhập:</label><input type="text" id="username" required></div>
                <div><label for="password">Mật khẩu:</label><input type="password" id="password" required></div>
                <button type="submit">Đăng Nhập</button>
                <p id="login-message"></p>
            </form>
        </div>

        <div id="page-admin" class="page">
            <h2>Trang Quản Trị</h2>
            <h3>Thống kê doanh số (Grafana)</h3>
            <div class="grafana-container">
                <iframe src="http://localhost:3000/d-solo/your-dashboard-id/your-dashboard-name?orgId=1&panelId=2&theme=light" width="100%" height="300" frameborder="0"></iframe>
                <p><i>(<b>Lưu ý:</b> Bạn cần thay thế link <code>src</code> ở trên bằng link "Embed" từ Grafana của bạn.)</i></p>
            </div>
            <h3 style="margin-top: 2rem;">Quản lý Đơn hàng</h3>
            <table id="admin-order-table">
                <thead>
                    <tr>
                        <th>ID</th><th>Khách hàng</th><th>SĐT</th><th>Địa chỉ</th>
                        <th>Tổng tiền</th><th>Trạng thái</th><th>Mã COD</th><th>Hành động</th>
                    </tr>
                </thead>
                <tbody id="admin-order-list"><tr><td colspan="8">Đang tải đơn hàng...</td></tr></tbody>
            </table>
        </div>
    </main>

    <script>
        const API_URL = '/nodered';
        
        // --- BIẾN TOÀN CỤC ---
        let currentUser = null;
        let allProducts = []; // (MỚI) Lưu trữ danh sách sản phẩm
        let cart = {};        // (MỚI) Lưu giỏ hàng. Vd: { 1: { ...product, quantity: 2 }, 5: { ... } }

        // --- Lấy các phần tử DOM ---
        const pages = document.querySelectorAll('.page');
        const productListDiv = document.getElementById('product-list');
        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');
        
        // --- 1. HÀM ĐIỀU HƯỚNG (ROUTER) ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.toggle('active', page.id === pageId));
        }

        // --- 2. HÀM GỌI API (FETCH) ---

        // A. Gọi API lấy sản phẩm
        async function fetchProducts() {
            try {
                const response = await fetch(`${API_URL}/products`);
                const products = await response.json();
                allProducts = products; // (MỚI) Lưu vào biến toàn cục
                renderProducts(products);
            } catch (error) {
                console.error('Lỗi khi tải sản phẩm:', error);
                productListDiv.innerHTML = '<p>Không thể tải sản phẩm. Vui lòng thử lại.</p>';
            }
        }

        // B. Gọi API Login
        async function handleLogin(event) {
            event.preventDefault(); 
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            loginMessage.textContent = 'Đang kiểm tra...';

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, password: password })
                });
                const result = await response.json();

                if (result.success) {
                    loginMessage.textContent = '';
                    alert(`Đăng nhập thành công! Chào ${result.user.username}`);
                    currentUser = result.user; 
                    updateLoginUI(); 
                    showPage('page-products');
                } else {
                    currentUser = null;
                    loginMessage.textContent = result.message || 'Lỗi không xác định.';
                }
            } catch (error) {
                currentUser = null;
                console.error('Lỗi khi đăng nhập:', error);
                loginMessage.textContent = 'Lỗi kết nối. Không thể đăng nhập.';
            }
        }

        // C. (ADMIN) Hàm gọi API lấy danh sách đơn hàng
        async function fetchAdminOrders() {
            const orderListBody = document.getElementById('admin-order-list');
            orderListBody.innerHTML = '<tr><td colspan="8">Đang tải đơn hàng...</td></tr>';
            try {
                const response = await fetch(`${API_URL}/admin/orders`); 
                const orders = await response.json();
                renderAdminOrders(orders);
            } catch (error) {
                console.error('Lỗi khi tải đơn hàng:', error);
                orderListBody.innerHTML = '<tr><td colspan="8">Không thể tải đơn hàng.</td></tr>';
            }
        }

        // D. (ADMIN) Hàm gọi API cập nhật đơn hàng
        async function updateOrder(buttonElement, orderId) {
            const row = buttonElement.closest('tr'); 
            const newStatus = row.querySelector('.order-status').value;
            const newCodCode = row.querySelector('.order-cod').value;

            try {
                const response = await fetch(`${API_URL}/admin/order/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        status: newStatus,
                        cod_code: newCodCode
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Cập nhật đơn hàng thành công!');
                } else {
                    alert('Cập nhật thất bại.');
                }
            } catch (error) {
                console.error('Lỗi khi cập nhật đơn hàng:', error);
                alert('Lỗi kết nối khi cập nhật.');
            }
        }
        
        // E. (MỚI) Hàm gọi API Đặt Hàng
        async function handleCheckout(event) {
            event.preventDefault();
            
            // 1. Lấy thông tin khách hàng
            const customerInfo = {
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                address: document.getElementById('customerAddress').value
            };
            
            // 2. Chuẩn bị giỏ hàng
            const cartItems = Object.values(cart).map(item => ({
                product_id: item.id,
                quantity: item.quantity,
                price_per_unit: item.price
            }));
            
            // 3. Tính tổng tiền
            let totalAmount = cartItems.reduce((sum, item) => sum + (item.price_per_unit * item.quantity), 0);
            
            try {
                // 4. Gọi API
                const response = await fetch(`${API_URL}/order/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customerInfo: customerInfo,
                        cartItems: cartItems,
                        totalAmount: totalAmount,
                        userId: currentUser ? currentUser.id : null // Gửi ID user nếu đã đăng nhập
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Đặt hàng thành công! Cảm ơn bạn đã mua hàng.');
                    cart = {}; // Xoá sạch giỏ hàng
                    updateCartUI(); // Cập nhật bộ đếm về 0
                    showPage('page-products'); // Quay về trang chủ
                } else {
                    alert('Đặt hàng thất bại: ' + result.message);
                }
            } catch (error) {
                console.error('Lỗi khi đặt hàng:', error);
                alert('Lỗi kết nối khi đặt hàng.');
            }
        }

        // --- 3. HÀM RENDER & LOGIC GIỎ HÀNG ---

        // (MỚI) Hàm Thêm vào giỏ
        function addToCart(productId) {
            // 1. Tìm sản phẩm
            const product = allProducts.find(p => p.id === productId);
            if (!product) return; 

            // 2. Thêm hoặc tăng số lượng
            if (cart[productId]) {
                cart[productId].quantity++;
            } else {
                cart[productId] = { ...product, quantity: 1 };
            }
            
            updateCartUI();
            alert(`${product.name} đã được thêm vào giỏ!`);
        }

        // (MỚI) Hàm Cập nhật số lượng
        function updateCartQuantity(productId, newQuantity) {
            const quantity = parseInt(newQuantity);
            if (quantity > 0 && cart[productId]) {
                cart[productId].quantity = quantity;
            } else if (cart[productId]) { 
                // Nếu số lượng <= 0, xoá luôn
                delete cart[productId];
            }
            updateCartUI();
            renderCart(); // Vẽ lại giỏ hàng
        }

        // (MỚI) Hàm Xoá khỏi giỏ
        function removeFromCart(productId) {
            if (cart[productId]) {
                if (confirm(`Bạn có chắc muốn xoá ${cart[productId].name} khỏi giỏ hàng?`)) {
                    delete cart[productId];
                    updateCartUI();
                    renderCart();
                }
            }
        }

        // (MỚI) Hàm Cập nhật bộ đếm giỏ hàng
        function updateCartUI() {
            const cartCount = document.getElementById('cart-count');
            let totalItems = 0;
            for (const productId in cart) {
                totalItems += cart[productId].quantity;
            }
            cartCount.textContent = totalItems;
        }

        // (MỚI) Hàm Vẽ trang giỏ hàng
        function renderCart() {
            const cartPage = document.getElementById('page-cart');
            
            // 1. Nếu giỏ hàng trống
            if (Object.keys(cart).length === 0) {
                cartPage.innerHTML = '<h2>Giỏ Hàng Của Bạn</h2><p>Giỏ hàng của bạn đang trống.</p>';
                return;
            }

            // 2. Render bảng sản phẩm
            let totalAmount = 0;
            let cartHtml = '<h2>Giỏ Hàng Của Bạn</h2><table id="cart-table">';
            cartHtml += `
                <thead>
                    <tr>
                        <th>Sản phẩm</th><th>Hình ảnh</th><th>Đơn giá</th>
                        <th>Số lượng</th><th>Thành tiền</th><th>Xoá</th>
                    </tr>
                </thead><tbody>
            `;
            for (const productId in cart) {
                const item = cart[productId];
                const itemTotal = item.price * item.quantity;
                totalAmount += itemTotal;
                
                cartHtml += `
                    <tr>
                        <td>${item.name}</td>
                        <td><img src="${item.image_url}" alt="${item.name}"></td>
                        <td>${item.price.toLocaleString('vi-VN')} đ</td>
                        <td>
                            <input type="number" value="${item.quantity}" min="1" 
                                   onchange="updateCartQuantity(${productId}, this.value)">
                        </td>
                        <td>${itemTotal.toLocaleString('vi-VN')} đ</td>
                        <td><button class="remove-btn" onclick="removeFromCart(${productId})">Xoá</button></td>
                    </tr>
                `;
            }
            cartHtml += '</tbody></table>';
            
            // 3. Thêm tổng tiền
            cartHtml += `<div class="cart-summary">
                            <h3>Tổng cộng: ${totalAmount.toLocaleString('vi-VN')} đ</h3>
                         </div>`;
            
            // 4. Thêm Form Đặt Hàng
            cartHtml += `
                <div id="checkout-form">
                    <h3>Thông tin đặt hàng</h3>
                    <form onsubmit="handleCheckout(event)">
                        <div>
                            <label for="customerName">Họ tên:</label>
                            <input type="text" id="customerName" required>
                        </div>
                        <div>
                            <label for="customerPhone">Số điện thoại:</label>
                            <input type="tel" id="customerPhone" required>
                        </div>
                        <div>
                            <label for="customerAddress">Địa chỉ:</label>
                            <textarea id="customerAddress" rows="3" required></textarea>
                        </div>
                        <button type="submit">Xác Nhận Đặt Hàng</button>
                    </form>
                </div>
            `;
            
            cartPage.innerHTML = cartHtml;
        }

        // --- HÀM RENDER (Cũ) ---
        function renderProducts(products) {
            productListDiv.innerHTML = ''; 
            if (products.length === 0) {
                productListDiv.innerHTML = '<p>Chưa có sản phẩm nào.</p>';
                return;
            }
            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product-item';
                const imageUrl = product.image_url || 'https://via.placeholder.com/200?text=No+Image';
                productDiv.innerHTML = `
                    <img src="${imageUrl}" alt="${product.name}">
                    <h3>${product.name}</h3>
                    <p>${product.price.toLocaleString('vi-VN')} đ</p>
                    <button onclick="addToCart(${product.id})">Thêm vào giỏ</button>
                `;
                productListDiv.appendChild(productDiv);
            });
        }
        
        function updateLoginUI() {
            const navLogin = document.getElementById('nav-login');
            const navAdmin = document.getElementById('nav-admin');
            if (currentUser) {
                navLogin.textContent = 'Đăng Xuất';
                if (currentUser.role === 'admin') {
                    navAdmin.style.display = 'inline'; 
                } else {
                    navAdmin.style.display = 'none'; 
                }
            } else {
                navLogin.textContent = 'Đăng Nhập';
                navAdmin.style.display = 'none';
            }
        }

        function renderAdminOrders(orders) {
            const orderListBody = document.getElementById('admin-order-list');
            orderListBody.innerHTML = ''; 
            if (orders.length === 0) {
                orderListBody.innerHTML = '<tr><td colspan="8">Không có đơn hàng nào cần xử lý.</td></tr>';
                return;
            }
            orders.forEach(order => {
                const row = document.createElement('tr');
                row.setAttribute('data-order-id', order.id);
                const statuses = ['pending', 'confirmed', 'packing', 'shipped', 'delivered', 'canceled'];
                let statusDropdown = `<select class="order-status">`;
                statuses.forEach(status => {
                    statusDropdown += `<option value="${status}" ${order.status === status ? 'selected' : ''}>${status}</option>`;
                });
                statusDropdown += `</select>`;
                row.innerHTML = `
                    <td>${order.id}</td> <td>${order.customer_name}</td> <td>${order.customer_phone}</td>
                    <td>${order.shipping_address}</td> <td>${order.total_amount.toLocaleString('vi-VN')} đ</td>
                    <td>${statusDropdown}</td>
                    <td><input type="text" class="order-cod" value="${order.cod_code || ''}"></td>
                    <td><button onclick="updateOrder(this, ${order.id})">Cập nhật</button></td>
                `;
                orderListBody.appendChild(row);
            });
        }

        // --- 4. KHỞI CHẠY KHI TẢI TRANG ---
        document.addEventListener('DOMContentLoaded', () => {
            
            document.getElementById('nav-products').addEventListener('click', () => showPage('page-products'));
            
            // (MỚI) Cập nhật sự kiện click cho Giỏ hàng
            document.getElementById('nav-cart').addEventListener('click', () => {
                showPage('page-cart');
                renderCart(); // Gọi hàm render giỏ hàng
            });
            
            document.getElementById('nav-admin').addEventListener('click', () => {
                showPage('page-admin');
                fetchAdminOrders(); 
            });
            
            document.getElementById('nav-login').addEventListener('click', () => {
                if (currentUser) {
                    if (confirm('Bạn có muốn đăng xuất?')) {
                        currentUser = null;
                        updateLoginUI();
                        showPage('page-products'); 
                    }
                } else {
                    showPage('page-login');
                }
            });

            loginForm.addEventListener('submit', handleLogin);
            fetchProducts();
            showPage('page-products');
        });

    </script>
</body>
</html>